@page "/gestionproveedor"
@inject HttpClient Http

<div class="gestor-proveedores">
    <h3 class="titulo-principal">Gestión de Proveedores</h3>

    <div class="contenedor-principal">
        <!-- Formulario de proveedor -->
        <div class="panel-formulario">
            <div class="encabezado-panel">
                <h4>@(modoEditar ? "Editar Proveedor" : "Nuevo Proveedor")</h4>
            </div>

            <div class="formulario">
                <div class="form-grid">
                    <div class="grupo-formulario">
                        <label>Nombre:</label>
                        <input type="text" @bind="nuevoProveedor.nombre" placeholder="Nombre del proveedor" />
                    </div>

                    <div class="grupo-formulario">
                        <label>Razón Social:</label>
                        <input type="text" @bind="nuevoProveedor.razonSocial" placeholder="Razón social" />
                    </div>

                    <div class="grupo-formulario">
                        <label>Persona de Contacto:</label>
                        <input type="text" @bind="nuevoProveedor.contacto" placeholder="Nombre del contacto" />
                    </div>

                    <div class="grupo-formulario">
                        <label>Teléfono:</label>
                        <input type="text" @bind="nuevoProveedor.telefono" placeholder="Número de teléfono" />
                    </div>

                    <div class="grupo-formulario">
                        <label>Fecha de Ingreso:</label>
                        <input type="date" @bind="nuevoProveedor.diaIngreso" format-value="yyyy-MM-dd" />
                    </div>
                </div>

                <div class="acciones-formulario">
                    <button class="btn-guardar" @onclick="GuardarProveedor">
                        <i class="icono-guardar"></i> @(modoEditar ? "Actualizar" : "Guardar")
                    </button>
                    @if (modoEditar)
                    {
                        <button class="btn-cancelar" @onclick="CancelarEdicion">
                            <i class="icono-cancelar"></i> Cancelar
                        </button>
                    }
                </div>
            </div>
        </div>

        <!-- Lista de proveedores -->
        <div class="panel-lista">
            <div class="encabezado-panel">
                <h4>Lista de Proveedores</h4>
                <div class="busqueda">
                    <input type="text" placeholder="Buscar proveedores..." @bind="filtroBusqueda"
                           @oninput="(e) => { filtroBusqueda = e.Value.ToString(); FiltrarProveedores(); }" />
                    <i class="icono-buscar"></i>
                </div>
            </div>

            <div class="contenedor-tabla">
                @if (proveedoresFiltrados?.Any() == true)
                {
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Razón Social</th>
                                <th>Contacto</th>
                                <th>Teléfono</th>
                                <th>Fecha Ingreso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var proveedor in proveedoresFiltrados)
                            {
                                <tr>
                                    <td>@proveedor.idProveedor</td>
                                    <td>@proveedor.nombre</td>
                                    <td>@proveedor.razonSocial</td>
                                    <td>@proveedor.contacto</td>
                                    <td>@proveedor.telefono</td>
                                    <td>@proveedor.diaIngreso.ToString("dd/MM/yyyy")</td>
                                    <td class="acciones">
                                        <button class="btn-editar" @onclick="() => EditarProveedor(proveedor)" title="Editar">
                                            <i class="icono-editar"></i>
                                        </button>
                                        <button class="btn-eliminar" @onclick="() => EliminarProveedor(proveedor.idProveedor)" title="Eliminar">
                                            <i class="icono-eliminar"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="sin-resultados">
                        <i class="icono-proveedor"></i>
                        <p>No se encontraron proveedores</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos base */
    .gestor-proveedores {
        font-family: 'Segoe UI', Arial, sans-serif;
        padding: 20px;
        background-color: #f5f7fa;
        min-height: 100vh;
    }

    .titulo-principal {
        color: #1A2E5A;
        margin-bottom: 25px;
        font-weight: 600;
        border-bottom: 2px solid #E30613;
        padding-bottom: 8px;
        display: inline-block;
    }

    .contenedor-principal {
        display: flex;
        gap: 25px;
        flex-wrap: wrap;
    }

    .panel-lista, .panel-formulario {
        flex: 1;
        min-width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .encabezado-panel {
        background-color: #1A2E5A;
        color: white;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .encabezado-panel h4 {
            margin: 0;
            font-weight: 500;
            font-size: 16px;
        }

    .busqueda {
        position: relative;
        width: 200px;
    }

        .busqueda input {
            width: 100%;
            padding: 8px 30px 8px 10px;
            border-radius: 4px;
            border: none;
            font-size: 14px;
        }

    .icono-buscar {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231A2E5A'%3E%3Cpath d='M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
        background-size: contain;
        background-repeat: no-repeat;
    }

    .contenedor-tabla {
        padding: 15px;
        max-height: 600px;
        overflow-y: auto;
    }

    .formulario {
        padding: 20px;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .grupo-formulario {
        margin-bottom: 15px;
    }

    label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #1A2E5A;
        font-size: 14px;
    }

    input, select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

        input:focus, select:focus {
            outline: none;
            border-color: #1A2E5A;
            box-shadow: 0 0 0 2px rgba(26, 46, 90, 0.2);
        }

    .acciones-formulario {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    /* Tabla */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    th {
        background-color: #f8f9fa;
        color: #1A2E5A;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
        position: sticky;
        top: 0;
    }

    td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
        color: #495057;
    }

    tr:hover {
        background-color: #f8f9fa;
    }

    .acciones {
        display: flex;
        gap: 5px;
    }

        .acciones button {
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

    .btn-editar {
        color: #1A2E5A;
    }

        .btn-editar:hover {
            background-color: rgba(26, 46, 90, 0.1);
        }

    .btn-eliminar {
        color: #E30613;
    }

        .btn-eliminar:hover {
            background-color: rgba(227, 6, 19, 0.1);
        }

    .icono-editar, .icono-eliminar {
        display: inline-block;
        width: 18px;
        height: 18px;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .icono-editar {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231A2E5A'%3E%3Cpath d='M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z'/%3E%3C/svg%3E");
    }

    .icono-eliminar {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23E30613'%3E%3Cpath d='M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z'/%3E%3C/svg%3E");
    }

    .sin-resultados {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 0;
        color: #6c757d;
    }

    .icono-proveedor {
        width: 50px;
        height: 50px;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2zM5 8V7h2v3.82C5.84 10.4 5 9.3 5 8zm14 0c0 1.3-.84 2.4-2 2.82V7h2v1z'/%3E%3C/svg%3E");
        background-size: contain;
        background-repeat: no-repeat;
        margin-bottom: 15px;
    }

    /* Botones */
    .btn-guardar {
        background-color: #1A2E5A;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .btn-guardar:hover {
            background-color: #142445;
        }

    .btn-cancelar {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

        .btn-cancelar:hover {
            background-color: #5a6268;
        }

    .icono-guardar, .icono-cancelar {
        display: inline-block;
        width: 16px;
        height: 16px;
        background-size: contain;
        background-repeat: no-repeat;
    }

    .icono-guardar {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z'/%3E%3C/svg%3E");
    }

    .icono-cancelar {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .contenedor-principal {
            flex-direction: column;
        }

        .panel-lista, .panel-formulario {
            min-width: 100%;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .acciones {
            justify-content: center;
        }
    }
</style>

@code {
    List<Proveedor> proveedores = new();
    List<Proveedor> proveedoresFiltrados = new();
    Proveedor nuevoProveedor = new();
    string filtroBusqueda = "";
    bool modoEditar = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarProveedores();
    }

    async Task CargarProveedores()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<List<Proveedor>>("api/Proveedor/obtener-todos");
            if (response is not null)
            {
                proveedores = response;
                FiltrarProveedores();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error al cargar proveedores: " + ex.Message);
        }
    }

    void FiltrarProveedores()
    {
        if (string.IsNullOrWhiteSpace(filtroBusqueda))
        {
            proveedoresFiltrados = proveedores.ToList();
        }
        else
        {
            var termino = filtroBusqueda.ToLower();
            proveedoresFiltrados = proveedores.Where(p =>
                p.nombre.ToLower().Contains(termino) ||
                p.razonSocial.ToLower().Contains(termino) ||
                p.contacto.ToLower().Contains(termino) ||
                p.telefono.ToLower().Contains(termino) ||
                p.idProveedor.ToString().Contains(termino)
            ).ToList();
        }
    }

    async Task GuardarProveedor()
    {
        try
        {
            if (modoEditar)
            {
                var response = await Http.PutAsJsonAsync($"api/Proveedor/actualizar/{nuevoProveedor.idProveedor}", nuevoProveedor);
                if (response.IsSuccessStatusCode)
                {
                    modoEditar = false;
                    nuevoProveedor = new();
                    await CargarProveedores();
                }
            }
            else
            {
                var response = await Http.PostAsJsonAsync("api/Proveedor/registrar", nuevoProveedor);
                if (response.IsSuccessStatusCode)
                {
                    nuevoProveedor = new();
                    await CargarProveedores();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error al guardar proveedor: " + ex.Message);
        }
    }

    void EditarProveedor(Proveedor proveedor)
    {
        nuevoProveedor = new Proveedor
            {
                idProveedor = proveedor.idProveedor,
                nombre = proveedor.nombre,
                razonSocial = proveedor.razonSocial,
                contacto = proveedor.contacto,
                telefono = proveedor.telefono,
                diaIngreso = proveedor.diaIngreso
            };
        modoEditar = true;
    }

    void CancelarEdicion()
    {
        nuevoProveedor = new();
        modoEditar = false;
    }

    async Task EliminarProveedor(int idProveedor)
    {
        try
        {
            var response = await Http.DeleteAsync($"api/Proveedor/eliminar/{idProveedor}");
            if (response.IsSuccessStatusCode)
            {
                await CargarProveedores();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error al eliminar proveedor: " + ex.Message);
        }
    }

    public class Proveedor
    {
        public int idProveedor { get; set; }
        public string nombre { get; set; } = string.Empty;
        public string razonSocial { get; set; } = string.Empty;
        public string contacto { get; set; } = string.Empty;
        public string telefono { get; set; } = string.Empty;
        public DateTime diaIngreso { get; set; } = DateTime.Now;
    }
}